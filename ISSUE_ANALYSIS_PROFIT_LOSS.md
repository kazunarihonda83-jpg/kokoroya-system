# 損益計算書に受注取引データが反映されない問題 - 原因分析と解決策

## 問題の概要
受注取引一覧で登録したデータが損益計算書に反映されない（売上高が0と表示される）

## 調査結果

### 1. データベース状態（ローカル環境）✅
- **顧客データ**: 2件登録済み（テスト株式会社、山田太郎）
- **受注取引**: 1件登録済み（OR-20260212-0001、合計¥10,450、支払済み）
- **受注明細**: 2件
  - ラーメン（醤油） 10個 × ¥800 = ¥8,000
  - 餃子セット 5個 × ¥300 = ¥1,500
- **仕訳データ**: 売上高の仕訳が正しく登録されている
  - 日付: 2026-02-12
  - 借方: 現金（勘定科目ID: 1） ¥10,450
  - 貸方: 売上高（勘定科目ID: 8、コード4000） ¥10,450
  - 摘要: テスト株式会社 現金売上 (OR-20260212-0001)

### 2. バックエンドAPI動作確認 ✅
```bash
GET /api/accounting/profit-loss?start_date=2026-02-01&end_date=2026-02-28
```

**レスポンス**:
```json
{
  "sales_revenue": 10450,
  "cost_of_sales": 7700,
  "gross_profit": 2750,
  "selling_expenses": 455000,
  "operating_income": -452250,
  "non_operating_income": 0,
  "non_operating_expense": 0,
  "ordinary_income": -452250,
  "extraordinary_income": 0,
  "extraordinary_loss": 0,
  "income_before_tax": -452250,
  "corporate_tax": 0,
  "net_income": -452250
}
```

✅ **バックエンドは正常動作**: `sales_revenue: 10450` が正しく返されている

### 3. 問題の根本原因 ⚠️

#### フロントエンドの接続先設定
- **`.env.production`**: `VITE_API_URL=https://menya-nishiki-system-cloud.onrender.com/api`
- **`.env.development`**: `VITE_API_URL=/api` （プロキシ経由でローカル）

#### 問題点
1. ビルド済みフロントエンド（`dist/`）は**本番環境（Render）のAPI**に接続
2. ローカルバックエンド（`http://localhost:5003`）のデータは参照されていない
3. Render本番環境のDBには、ユーザーが登録したデータとは異なるデータが存在
   - 本番DB: 顧客3件（j、h、千葉食材センター）、受注2件（各¥1,100）
   - ローカルDB: 顧客2件（テスト株式会社、山田太郎）、受注1件（¥10,450）

## 解決策

### オプション1: 開発サーバーで確認（推奨）
```bash
cd /home/user/webapp/menya-nishiki-order-management-system
npm run dev
```
- これにより `.env.development` が使用され、ローカルAPIに接続
- URL: `http://localhost:5173`
- バックエンド: `http://localhost:5003/api` (プロキシ経由)

### オプション2: ビルド版でローカルAPIを参照
`.env.production.local` を作成して、ビルド版でもローカルAPIを使用：
```
VITE_API_URL=http://localhost:5003/api
```

その後再ビルド：
```bash
npm run build
```

### オプション3: 本番環境（Render）のDBを更新
Renderの本番環境にも同じ顧客・受注データを登録する必要があります。

## 確認手順

### ローカル環境で確認
1. フロントエンド開発サーバー起動:
   ```bash
   npm run dev
   ```

2. ブラウザで `http://localhost:5173` にアクセス

3. ログイン（ユーザー名: 麺家弍色、パスワード: admin123）

4. 会計帳簿 → 損益計算書

5. 期間設定: 2026-02-01 ～ 2026-02-28

6. **期待される表示**:
   - 売上高: ¥10,450
   - 売上原価: ¥7,700
   - 売上総利益: ¥2,750
   - 販売費及び一般管理費: ¥455,000
   - 営業利益: -¥452,250

### ビルド版で確認
1. `.env.production.local` が正しく設定されているか確認
2. `npm run build` で再ビルド
3. ブラウザのキャッシュをクリア（Ctrl+Shift+R または Cmd+Shift+R）
4. `http://localhost:3013` にアクセスして確認

## テストデータ詳細

### ローカルDB（正常動作）
- **受注取引ID**: 1
- **伝票番号**: OR-20260212-0001
- **顧客**: テスト株式会社（ID: 1）
- **受注日**: 2026-02-12
- **支払状況**: 支払済み（paid）
- **合計金額**: ¥10,450
- **明細**:
  - ラーメン（醤油）: 10個 × ¥800 = ¥8,000
  - 餃子セット: 5個 × ¥300 = ¥1,500
  - 小計: ¥9,500
  - 消費税（10%）: ¥950
  - 合計: ¥10,450

### 仕訳内容
```
日付: 2026-02-12
借方: 現金 ¥10,450
貸方: 売上高 ¥10,450
摘要: テスト株式会社 現金売上 (OR-20260212-0001)
参照タイプ: order_receipt
参照ID: 1
```

## まとめ

**問題**: フロントエンドが本番環境（Render）のAPIに接続しており、ローカルバックエンドのデータが表示されていない

**解決**: `npm run dev` で開発サーバーを起動し、ローカルAPIに接続することで、正しく売上高 ¥10,450 が表示される

**検証済み**: ローカルバックエンドAPIは正常動作しており、受注取引データから仕訳データへの連携も問題なし

---
最終更新: 2026-02-12
調査者: Claude Code Agent
