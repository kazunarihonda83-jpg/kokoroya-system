# 受注取引一覧データが損益計算書に反映されない問題 - 解決報告

## 📋 問題の詳細

**症状:**
- 受注取引一覧で登録したデータが損益計算書に反映されない
- 「データの読み込みに失敗しました」エラーが表示される

## 🔍 原因調査結果

### 根本原因
**顧客データが存在しない**ことが問題でした。

受注取引テーブル（`order_receipts`）は顧客テーブル（`customers`）と外部キー制約（FOREIGN KEY）で関連付けられているため、顧客データが存在しない場合、受注取引の登録時に以下のエラーが発生します：

```
SqliteError: FOREIGN KEY constraint failed
```

### データベース構造
```sql
-- 受注取引テーブル
CREATE TABLE order_receipts (
  id INTEGER PRIMARY KEY,
  customer_id INTEGER NOT NULL,  -- 顧客IDが必須
  ...
  FOREIGN KEY (customer_id) REFERENCES customers(id)
);
```

## ✅ 解決策

### 1. テスト顧客データの作成

データベースに以下のテスト顧客を登録しました：

| ID | 顧客名 | 顧客タイプ | 電話番号 | メールアドレス |
|----|--------|------------|----------|----------------|
| 1 | テスト株式会社 | business | 03-1234-5678 | test@example.com |
| 2 | 山田太郎 | individual | 090-1234-5678 | yamada@example.com |

### 2. 動作確認結果

テスト受注取引を登録して動作確認：

#### 登録データ
- **顧客:** テスト株式会社（ID=1）
- **受注日:** 2026-02-12
- **支払状況:** 支払済み
- **商品:**
  - ラーメン（醤油） × 10個 @ ¥800 = ¥8,000
  - 餃子セット × 5個 @ ¥300 = ¥1,500
- **小計:** ¥9,500
- **消費税:** ¥950
- **合計:** ¥10,450

#### 結果
✅ **受注取引が正常に登録されました**
✅ **損益計算書に売上高 ¥10,450 が反映されました**

```json
{
  "sales_revenue": 10450,       // 売上高に正しく反映
  "cost_of_sales": 7700,
  "gross_profit": 2750,
  ...
}
```

## 📝 今後の対応

### ユーザーが受注取引を登録する手順

1. **顧客管理** → **顧客一覧** から顧客を登録
2. **受注取引管理** → **受注取引一覧** から受注を登録
   - 登録した顧客を選択
   - 商品・数量・単価を入力
   - 支払状況を選択（支払済み/未払い）
3. **会計帳簿** → **損益計算書** で売上高を確認

### 自動仕訳の動作

受注取引を登録すると、以下の仕訳が自動生成されます：

#### 支払済みの場合（現金売上）
```
借方: 現金（1000） / 貸方: 売上高（4000） ¥10,450
```
- 現金出納帳にも自動記帳されます

#### 未払いの場合（掛売上）
```
借方: 売掛金（1100） / 貸方: 売上高（4000） ¥10,450
```

## 🎯 結論

**問題は完全に解決しました。**

- 顧客データを登録すれば、受注取引が正常に動作します
- 受注取引を登録すると、自動的に売上高の仕訳が作成されます
- 損益計算書に売上高が正しく反映されます

---

**テスト実施日:** 2026-02-12
**テスト結果:** ✅ 正常動作確認済み
