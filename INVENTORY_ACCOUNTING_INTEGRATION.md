# 在庫管理と会計帳簿の連携機能

## 概要
在庫の入庫・出庫・調整時に、自動的に会計仕訳を生成する機能を実装しました。

## 実装内容

### 1. 自動追加される勘定科目
- **1300 商品**（資産）- 在庫資産
- **5100 売上原価**（費用）- 商品を販売した際の原価
- **7100 雑収入**（収益）- 在庫調整による増加
- **8100 雑損失**（費用）- 在庫調整による減少

### 2. 在庫移動時の仕訳ルール

#### ✅ 入庫（initial, in）
```
借方: 商品（資産）        ×× 円
貸方: 買掛金（負債）      ×× 円
```
- 商品を仕入れた際の仕訳
- 在庫資産が増加し、買掛金（支払義務）が発生

#### ✅ 出庫（out）
```
借方: 売上原価（費用）    ×× 円
貸方: 商品（資産）        ×× 円
```
- 商品を販売・使用した際の仕訳
- 在庫資産が減少し、売上原価（費用）が計上

#### ✅ 在庫調整 - 増加（adjustment +）
```
借方: 商品（資産）        ×× 円
貸方: 雑収入（収益）      ×× 円
```
- 棚卸で在庫が増えていた場合
- 在庫資産が増加し、雑収入が計上

#### ✅ 在庫調整 - 減少（adjustment -）
```
借方: 雑損失（費用）      ×× 円
貸方: 商品（資産）        ×× 円
```
- 棚卸で在庫が減っていた場合、または廃棄・紛失
- 在庫資産が減少し、雑損失が計上

## 実装ファイル

### server/routes/inventory.js
在庫管理のメインロジック。以下の機能を追加：
- `ensureInventoryAccounts()` - 必要な勘定科目を自動作成
- `createInventoryJournalEntry()` - 在庫移動時に仕訳を自動生成
- 在庫新規作成時の仕訳生成
- 在庫移動時の仕訳生成

### migrate-inventory-journal.js
既存の在庫移動履歴から仕訳を遡及生成するスクリプト。

## 使用方法

### 初回セットアップ（既存データがある場合）
```bash
node migrate-inventory-journal.js
```

### 通常の運用
在庫管理画面から以下の操作を行うと、自動的に仕訳が生成されます：
1. **在庫新規登録** - 初期在庫として入庫仕訳が生成
2. **在庫入庫** - 入庫仕訳が生成
3. **在庫出庫** - 出庫仕訳が生成
4. **在庫調整** - 増減に応じた仕訳が生成

## 確認方法

### 1. 在庫データの確認
```bash
# 在庫一覧APIで確認
GET /api/inventory
```

### 2. 仕訳データの確認
```bash
# 仕訳帳APIで確認
GET /api/accounting/journal?start_date=2026-02-01&end_date=2026-02-28
```

仕訳の `reference_type` が `inventory_movement` のものが在庫関連の仕訳です。

### 3. 会計帳簿での確認
- **総勘定元帳**: 「商品」勘定の動きを確認
- **損益計算書**: 「売上原価」「雑収入」「雑損失」を確認
- **貸借対照表**: 「商品」（資産）、「買掛金」（負債）を確認

## データ例

### 在庫入庫の仕訳例
```json
{
  "entry_date": "2026-02-12",
  "description": "在庫入庫: ねぎ 10個 (初期在庫登録)",
  "debit_account_name": "商品",
  "debit_account_code": "1300",
  "credit_account_name": "買掛金",
  "credit_account_code": "2000",
  "amount": 500,
  "reference_type": "inventory_movement"
}
```

## 注意事項
1. 在庫移動履歴が削除されても、仕訳は残ります
2. 仕訳の手動削除は推奨されません（会計の整合性のため）
3. 在庫単価（unit_cost）が重要です。必ず適切な単価を設定してください

## トラブルシューティング

### Q: 在庫を登録したのに仕訳が生成されない
A: サーバーログを確認してください。勘定科目が正しく作成されているか確認：
```bash
# データベースで勘定科目を確認
SELECT * FROM accounts WHERE account_code IN ('1300', '5100', '7100', '8100');
```

### Q: 既存の在庫データに仕訳を追加したい
A: マイグレーションスクリプトを実行：
```bash
node migrate-inventory-journal.js
```

### Q: 仕訳が重複して生成される
A: `reference_type='inventory_movement'` かつ `reference_id` が同じ仕訳が既に存在する場合、
   スクリプトは自動的にスキップします。

## 今後の拡張案
- [ ] 在庫評価方法の選択（先入先出法、移動平均法など）
- [ ] 仕訳の自動削除（在庫移動履歴削除時）
- [ ] 月次在庫報告書の自動生成
- [ ] 在庫回転率の計算と表示

---
**作成日**: 2026-02-13  
**バージョン**: 1.0.0  
**担当**: AI Assistant
