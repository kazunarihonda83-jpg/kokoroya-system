# 現金購入モード実装完了報告

## 📅 実装完了日
2026-02-13

## 🎯 実装目的
在庫登録時に**損益計算書**と**キャッシュフロー計算書**に即座に反映されるよう、在庫購入を現金取引として処理する。

## ✅ 実装内容

### 1. 在庫仕訳の変更

#### 変更前（買掛金モード）
```
在庫入庫時の仕訳:
借方: 商品（資産 1300） ¥2,200
貸方: 買掛金（負債 2000） ¥2,200

影響:
- 貸借対照表: 資産↑ 負債↑
- 損益計算書: 影響なし
- キャッシュフロー: 影響なし（買掛金なので現金は動かない）
```

#### 変更後（現金購入モード）✅
```
在庫入庫時の仕訳:
借方: 商品（資産 1300） ¥2,200
貸方: 現金（資産 1000） ¥2,200

影響:
- 貸借対照表: 商品資産↑ 現金資産↓
- 損益計算書: 影響なし（在庫は資産なので）
- キャッシュフロー: 営業支出 ¥2,200 ✅
```

### 2. キャッシュフローAPI修正

#### 変更箇所
**ファイル**: `server/routes/accounting.js`
**行数**: 1289-1305

#### 変更前
```javascript
} else if (otherAccountType === 'asset' && otherAccountCode !== '1300') {
  // 資産科目（商品以外）：売掛金回収など
  if (isCashDebit) {
    operatingCF.revenue += amount;
  }
}
```

#### 変更後
```javascript
} else if (otherAccountType === 'asset') {
  // 資産科目の処理
  if (otherAccountCode === '1300') {
    // 商品購入（借方：商品、貸方：現金）
    if (isCashCredit) {
      operatingCF.expenses += amount;
    }
  } else {
    // 売掛金回収など（借方：現金、貸方：売掛金）
    if (isCashDebit) {
      operatingCF.revenue += amount;
    }
  }
}
```

### 3. 在庫仕訳関数の修正

**ファイル**: `server/routes/inventory.js`
**行数**: 46-51

#### 変更前
```javascript
if (movementType === 'in' || movementType === 'initial') {
  // 入庫: 借方 商品 / 貸方 買掛金（または現金）
  debitAccount = '1300';  // 商品（資産）
  creditAccount = '2000'; // 買掛金（負債）
  description = `在庫入庫: ${inventory.item_name} ${Math.abs(quantity)}${inventory.unit}`;
}
```

#### 変更後
```javascript
if (movementType === 'in' || movementType === 'initial') {
  // 入庫: 借方 商品 / 貸方 現金（現金購入）
  debitAccount = '1300';  // 商品（資産）
  creditAccount = '1000'; // 現金（資産）
  description = `在庫入庫: ${inventory.item_name} ${Math.abs(quantity)}${inventory.unit}`;
}
```

## 📊 テスト結果

### テストケース1: 在庫登録（現金購入）

**操作:**
```bash
POST /api/inventory
{
  "item_name": "ねぎ",
  "category": "野菜",
  "unit": "個",
  "current_stock": 10,
  "unit_cost": 220
}
```

**生成された仕訳:**
```
日付: 2026-02-13
説明: 在庫入庫: ねぎ 10個 (初期在庫登録)
借方: 商品 (1300) ¥2,200
貸方: 現金 (1000) ¥2,200
```

**財務諸表への影響:**

| 諸表 | 項目 | 金額 | 備考 |
|------|------|------|------|
| 貸借対照表 | 商品資産 | ¥2,200 | 増加 ✅ |
| 貸借対照表 | 現金資産 | -¥2,200 | 減少 ✅ |
| 損益計算書 | - | - | 影響なし（在庫は資産） |
| キャッシュフロー | 営業支出 | ¥2,200 | ✅ **反映された！** |
| キャッシュフロー | 期末現金残高 | -¥2,200 | ✅ |

### テストケース2: 在庫出庫（販売・使用）

**操作:**
```bash
POST /api/inventory/:id/movement
{
  "movement_type": "out",
  "quantity": 3
}
```

**生成された仕訳:**
```
借方: 売上原価 (5100) ¥660
貸方: 商品 (1300) ¥660
```

**財務諸表への影響:**

| 諸表 | 項目 | 金額 | 備考 |
|------|------|------|------|
| 貸借対照表 | 商品資産 | ¥1,540 | 残り7個分 |
| 損益計算書 | 売上原価 | ¥660 | ✅ 計上された |
| 損益計算書 | 粗利益 | -¥660 | 売上なしの場合 |
| キャッシュフロー | - | - | 影響なし（非現金取引） |

### テストケース3: 売上と現金回収

**売上:**
```bash
POST /api/order-receipts
{
  "customer_id": 1,
  "items": [{"product_name":"ラーメン","quantity":1,"unit_price":1000}],
  "tax_rate": 10
}
```

**現金回収:**
```bash
POST /api/accounting/journal
{
  "debit_account_id": 1,    // 現金
  "credit_account_id": 2,   // 売掛金
  "amount": 1100
}
```

**最終結果:**

| 諸表 | 項目 | 金額 |
|------|------|------|
| 損益計算書 | 売上高 | ¥1,100 |
| 損益計算書 | 売上原価 | ¥660 |
| 損益計算書 | 粗利益 | ¥440 |
| 損益計算書 | 当期純利益 | ¥440 |
| キャッシュフロー | 営業収入 | ¥1,100 |
| キャッシュフロー | 営業支出 | ¥2,200 |
| キャッシュフロー | 営業CF純額 | -¥1,100 |
| 貸借対照表 | 現金 | -¥1,100 |
| 貸借対照表 | 商品 | ¥1,540 |

## 🎯 実装効果

### ✅ 達成された目標

1. **在庫登録時にキャッシュフローに反映される**
   - 在庫購入 ¥2,200 → キャッシュフロー支出 ¥2,200 ✅

2. **在庫出庫時に損益計算書に反映される**
   - 在庫出庫 3個 → 売上原価 ¥660 ✅

3. **リアルタイムの財務状況把握が可能**
   - 在庫購入の現金影響が即座に見える ✅
   - 売上原価の自動計上 ✅
   - 現金残高の正確な追跡 ✅

### 📈 ビジネスメリット

1. **キャッシュフロー管理の向上**
   - 在庫購入による現金支出が即座に可視化
   - 資金繰り計画の精度向上

2. **損益管理の正確性**
   - 在庫使用時に自動で売上原価計上
   - 粗利益の正確な把握

3. **業務効率化**
   - 手動での仕訳入力不要
   - 自動化による入力ミス削減

## ⚠️ 重要な注意事項

### 会計処理の変更点

**変更前（買掛金モード）:**
- 在庫購入 → 買掛金が発生（負債増加）
- 後で買掛金を支払う → キャッシュアウト
- 「掛取引」の概念

**変更後（現金購入モード）:**
- 在庫購入 → 即座に現金支払い（現金減少）
- 買掛金の概念は適用されない
- 「現金取引」のみ

### 適用ケース

この現金購入モードは以下のような業態に適しています：

✅ **適している業態:**
- 小規模飲食店（材料を都度現金購入）
- 露店・屋台（即金取引が主）
- 個人事業主（簡易的な現金管理）
- スタートアップ（シンプルな会計処理）

❌ **適していない業態:**
- 大規模企業（掛取引が一般的）
- 製造業（大量の材料を月締めで支払い）
- 卸売業（信用取引が主流）

## 📁 関連ファイル

### 変更されたコアファイル
- `server/routes/inventory.js` (2行変更)
- `server/routes/accounting.js` (15行変更)

### テストスクリプト
- `test-cash-purchase.sh`: 現金購入モード基本テスト
- `test-complete-flow.sh`: 入庫→出庫→売上の完全フロー
- `check-inventory-registration.sh`: 在庫登録状況確認

### ユーティリティ
- `clean-sandbox-data.sh`: データクリーンアップ
- `verify-clean-state.sh`: クリーン状態確認
- `explain-accounting-flow.sh`: 会計処理説明

### ドキュメント
- `DATA_CLEANUP_REPORT_2026-02-13.md`: データクリーンアップ報告
- `CASH_PURCHASE_MODE_COMPLETE.md`: 本ファイル

## 🚀 デプロイ手順

### 1. ローカル環境での確認
```bash
cd /home/user/webapp/menya-nishiki-order-management-system
./test-cash-purchase.sh
```

### 2. Git更新
```bash
git pull origin main
# サーバー再起動が必要
```

### 3. 本番環境デプロイ
- Render: 自動デプロイ（Git push後）
- Vercel: 自動ビルド＆デプロイ

## 🔍 動作確認手順

### 仮環境での確認

**URL**: https://3017-iwz00ie3gdkhvxpx2ni1z-5c13a017.sandbox.novita.ai

**ログイン:**
- ユーザー名: `麺家弍色`
- パスワード: `admin123`

**テスト手順:**
1. 在庫管理画面で新規在庫登録
   - 商品名: ねぎ
   - 数量: 10
   - 単価: 220
   - → 保存

2. キャッシュフロー計算書を確認
   - 営業キャッシュフロー支出: ¥2,200 が計上されているか ✅

3. 在庫管理画面で在庫出庫
   - 数量: 3
   - → 出庫

4. 損益計算書を確認
   - 売上原価: ¥660 が計上されているか ✅

## 📊 実装統計

- **変更ファイル数**: 2ファイル
- **変更行数**: 17行
- **追加ファイル数**: 7ファイル
- **追加行数**: 約720行（テスト・ドキュメント含む）
- **Git commit**: 418a132
- **実装時間**: 約1時間

## 🎉 完了宣言

**在庫データが損益計算書とキャッシュフロー計算書に即座に反映される現金購入モードの実装が完了しました！**

### 実装結果サマリー

✅ **在庫登録時**
- 自動仕訳: 借方 商品 / 貸方 現金
- キャッシュフロー計算書: 営業支出に即座反映
- 貸借対照表: 商品資産↑ 現金資産↓

✅ **在庫出庫時**
- 自動仕訳: 借方 売上原価 / 貸方 商品
- 損益計算書: 売上原価に即座反映
- 貸借対照表: 商品資産↓

✅ **財務諸表の整合性**
- 貸借対照表の資産＝負債＋純資産
- 損益計算書の純利益＝貸借対照表の純資産増減
- キャッシュフロー計算書の現金増減＝貸借対照表の現金増減

---

**実装完了日**: 2026-02-13  
**実装者**: AI Assistant  
**Git最終コミット**: 418a132 on main  
**リポジトリ**: https://github.com/kazunarihonda83-jpg/menya-nishiki-system-cloud.git  
**テスト環境**: https://3017-iwz00ie3gdkhvxpx2ni1z-5c13a017.sandbox.novita.ai
